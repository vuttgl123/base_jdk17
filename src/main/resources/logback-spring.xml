<?xml version="1.0" encoding="UTF-8"?>
<configuration scan="true" scanPeriod="30 seconds" packagingData="true">

    <property name="APP_NAME" value="${spring.application.name:-my-service}" />
    <property name="LOG_DIR" value="${LOG_DIR:-logs}" />
    <property name="LOG_FILE" value="${LOG_FILE:-${LOG_DIR}/${APP_NAME}.log}" />
    <timestamp key="byDay" datePattern="yyyy-MM-dd"/>

    <!-- Pattern encoder (dùng cho DEV) -->
    <appender name="DEV_CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d{yyyy-MM-dd'T'HH:mm:ss.SSSXXX} [%thread] %-5level %logger{36} - %msg
                | traceId=%X{traceId:-} spanId=%X{spanId:-} corrId=%X{correlationId:-}%n</pattern>
        </encoder>
    </appender>

    <!-- JSON encoder (dùng cho PROD) -->
    <appender name="JSON_CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
            <providers>
                <timestamp>
                    <timeZone>UTC</timeZone>
                    <fieldName>@timestamp</fieldName>
                </timestamp>
                <pattern>
                    <pattern>
                        {
                        "severity":"%level",
                        "logger":"%logger{36}",
                        "thread":"%thread",
                        "message":"%replace(%message){'(?s)\\n','\\\\n'}",
                        "traceId":"%mdc{traceId:-}",
                        "spanId":"%mdc{spanId:-}",
                        "correlationId":"%mdc{correlationId:-}",
                        "service":"${APP_NAME}",
                        "stack_trace":"%exception{full}"
                        }
                    </pattern>
                </pattern>
                <mdc/>      <!-- giữ lại toàn bộ MDC key khác -->
                <context/>  <!-- thông tin context logback -->
            </providers>
        </encoder>
    </appender>

    <!-- Rolling file (JSON) -->
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_FILE}</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>${LOG_FILE}.%d{yyyy-MM-dd}.%i.gz</fileNamePattern>
            <maxFileSize>50MB</maxFileSize>
            <maxHistory>14</maxHistory>
            <totalSizeCap>2GB</totalSizeCap>
        </rollingPolicy>
        <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
            <providers>
                <timestamp><timeZone>UTC</timeZone><fieldName>@timestamp</fieldName></timestamp>
                <pattern>
                    <pattern>
                        {
                        "severity":"%level",
                        "logger":"%logger{36}",
                        "thread":"%thread",
                        "message":"%replace(%message){'(?s)\\n','\\\\n'}",
                        "traceId":"%mdc{traceId:-}",
                        "spanId":"%mdc{spanId:-}",
                        "correlationId":"%mdc{correlationId:-}",
                        "service":"${APP_NAME}",
                        "stack_trace":"%exception{full}"
                        }
                    </pattern>
                </pattern>
                <mdc/>
                <context/>
            </providers>
        </encoder>
    </appender>

    <!-- Async để tránh block thread ứng dụng -->
    <appender name="ASYNC_JSON" class="ch.qos.logback.classic.AsyncAppender">
        <queueSize>8192</queueSize>
        <discardingThreshold>0</discardingThreshold>
        <neverBlock>true</neverBlock>
        <appender-ref ref="JSON_CONSOLE"/>
        <appender-ref ref="FILE"/>
    </appender>

    <!-- Môi trường DEV: pattern dễ đọc -->
    <springProfile name="dev,local,default">
        <root level="INFO">
            <appender-ref ref="DEV_CONSOLE"/>
        </root>
    </springProfile>

    <!-- Môi trường PROD: JSON -->
    <springProfile name="prod,uat,staging">
        <root level="INFO">
            <appender-ref ref="ASYNC_JSON"/>
        </root>
    </springProfile>

    <!-- Tinh chỉnh level cho các lib ồn ào -->
    <logger name="org.springframework" level="INFO"/>
    <logger name="org.hibernate.SQL" level="WARN"/>
    <logger name="org.hibernate.type.descriptor.sql" level="WARN"/>
    <logger name="org.apache.catalina" level="WARN"/>

</configuration>
